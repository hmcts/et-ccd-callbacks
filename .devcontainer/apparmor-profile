#include <tunables/global>

profile agent-devcontainer flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>

  # Deny write access to sensitive system directories
  deny /boot/** wl,
  deny /etc/shadow* rwklx,
  deny /etc/passwd* wl,
  deny /etc/group* wl,
  deny /etc/gshadow* rwklx,
  deny /etc/sudoers* rwklx,
  deny /etc/ssh/** wl,
  deny /root/.ssh/** rwklx,

  # Deny access to system binaries that could be dangerous
  deny /sbin/insmod x,
  deny /sbin/rmmod x,
  deny /sbin/modprobe x,
  deny /usr/sbin/insmod x,
  deny /usr/sbin/rmmod x,
  deny /usr/sbin/modprobe x,

  # Deny raw disk access
  deny /dev/sd* rwklx,
  deny /dev/hd* rwklx,
  deny /dev/nvme* rwklx,

  # Deny ptrace for security
  deny ptrace (read, trace),

  # Allow read access to most system files
  /etc/** r,
  /usr/** r,
  /lib/** r,
  /lib64/** r,

  # Allow execution of common binaries
  /bin/** ixr,
  /usr/bin/** ixr,
  /usr/local/bin/** ixr,
  /sbin/** ixr,
  /usr/sbin/** ixr,

  # Allow access to proc and sys (read-only where possible)
  /proc/** r,
  /proc/sys/kernel/random/uuid r,
  /sys/** r,

  # Allow /dev access for standard devices
  /dev/null rw,
  /dev/zero rw,
  /dev/full rw,
  /dev/random r,
  /dev/urandom r,
  /dev/tty rw,
  /dev/console rw,
  /dev/pts/* rw,
  /dev/ptmx rw,
  /dev/shm/** rw,

  # Allow tmp access
  /tmp/** rwlkix,
  /var/tmp/** rwlkix,

  # Allow home directory access for the vscode user
  /home/vscode/** rwlkix,
  /home/vscode/.* rwlk,

  # Allow workspace access
  /workspaces/** rwlkix,

  # Allow VS Code server volume
  /vscode/** rwlkix,

  # Allow package manager operations
  /var/lib/apt/** rwlk,
  /var/cache/apt/** rwlk,
  /var/log/apt/** rwlk,

  # Network access is controlled by iptables, allow socket operations
  network inet stream,
  network inet dgram,
  network inet6 stream,
  network inet6 dgram,
  network unix stream,
  network unix dgram,

  # Capabilities - restrict to minimum required
  capability chown,
  capability dac_override,
  capability dac_read_search,
  capability fowner,
  capability fsetid,
  capability kill,
  capability setgid,
  capability setuid,
  capability setpcap,
  capability net_bind_service,
  capability net_admin,
  capability net_raw,
  capability sys_chroot,
  capability mknod,
  capability audit_write,
  capability setfcap,

  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_boot,
  deny capability sys_ptrace,
}
